
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Bangkok congestion map</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<style type="text/css">
		
			html, body { 
			        height:100%
			    }
			#mapid{
				margin: 10px auto;
				width: 90%;
				height: 80%;
			}
			.info {
			    padding: 5px;
			    font: 29px sans-serif;
			    background: white;
			    background: rgba(255,255,255,0.8);
			    box-shadow: 0 0 10px rgba(0,0,0,0.2);
			    border-radius: 5px;
			}
			.legend {
			    line-height: 30px;
			    color: #555;
			}
			.legend i {
			    width: 29px;
			    height: 29px;
			    float: left;
			    margin-right: 5px;
			    opacity: 0.7;
			}
			#clock{
				height:60px;
				width: 200px;
				margin: 5px auto;
				text-align: center;
				font-size: 60px;
				color: black;
				background-color: #80d4ea;
			}
			#control{
				height:30px;
				width: 100px;
				margin: 5px auto;
				display: block;
				font-size: 20px;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<h1 style="text-align:center">Congestion map for Bangkok</h1>
		<div id='clock'></div>
  			<input type="button" id='control' value ='Autoplay'>
		<div id="mapid"></div>
		<script>
			var hour = 0;
			var min = 0;
			var time_id = 0;
			function getTime(){
				if (realTime){
					var now = new Date();
					var _hour = now.getHours();
					var _min = now.getMinutes();
					if(_min<20){
						time_id = _hour*2;
					}else if(_min<40){
						time_id = _hour*2+1;
					}else{
						time_id = _hour*2+2;
					}
				}else if(time_id<48){
					var _hour = parseInt(time_id/2); 
					var _min = (time_id%2)*30;
					time_id = time_id + 1;
					}else{
						var _hour = 0;
						var _min = 0;
						time_id = 1;
					}
				if (_hour<10){
					_hour = '0' + _hour;
				}
				if (_min<10){
					_min = '0' + _min;
				}
				var clock = $('#clock').text(_hour+":"+_min);
				console.log('DisplayTime: '+_hour+":"+_min);
				return time_id;
				}
			/*
			// code for open.mapquest tile
		    var map = L.map('mapid', {
			    layers: MQ.mapLayer(),
			    center: [ 13.736717, 100.523186 ],
			    zoom: 13,
			    renderer: L.canvas(),
			    });
			*/
		    // code for mapbox tile
		    var map = L.map('mapid',{renderer: L.canvas()}).setView([13.736717, 100.523186], 13);
			L.tileLayer( 'https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaHVzdGVyLXdnbSIsImEiOiJjaXl2OGo4ODkwMDE2Mnd1eml6ZjR2bHFhIn0.cNsihlDcPlI1eEuNwl_-vg', {
			    attribution: '&copy; <a href="http://huster-wgm.herokuapp.com/">Huster-wgm</a> Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			    maxZoom: 20
			}).addTo( map );	

			function getColor(d) {
				var colors = ['#238b45','#fee0d2','#fc9272','#de2d26'];
			    return d > 45   ? colors[0]:
			    	   d > 30   ? colors[1]:
			           d > 15   ? colors[2]:
			                      colors[3];
			}

			function getStyle(speed) {
			    return {
			        fillColor: getColor(speed),
				    radius: 4,
				    color:"white",
				    weight: 1,
				    opacity: 1,
				    fillOpacity: 0.8
			    };
			}

			var legend = L.control({position: 'bottomright'});
			legend.onAdd = function (map) {

				var div = L.DomUtil.create('div', 'info legend'),
					grades = [0, 15, 30, 45],
					labels = [],
					from, to;

				for (var i = 0; i < grades.length; i++) {
					from = grades[i];
					to = grades[i + 1];

					labels.push(
						'<i style="background:' + getColor(from + 1) + '"></i> ' +
						from + (to ? '&ndash;' + to : '+'));
				}

				div.innerHTML = labels.join('<br>');
				return div;
			};

			legend.addTo(map);
			/*
			request data from server and visualize by creating geoLayer
			*/
			function createMap() {
			    var geoData; 
			    $.ajax('./update_map', {
				    data: {'time': time_id},
				    dataType: 'json',
				    success: function (data){
				    	console.log("Time_id of data:"+time_id); 
				        // update time_id
					    if (!realTime){
					    	getTime();
					    };
					    // remove existed geoLayer
				        if (exist){
				        	geoLayer.remove();
				        }
				        console.log("Number of points: "+data.features.length);
				        geoLayer = L.geoJSON(data, {
		                    pointToLayer: function (feature, latlng) {
		                        var style = getStyle(feature.properties.speed);
		                        return L.circleMarker(latlng, style);}
				        });
				        // update map
				        geoLayer.addTo(map);
				        // set exist to true
				        exist = true;
				        console.log('Updating the geolayer');
				    } 
			    });
	
            };
            // get current time
            var realTime = true;
            // varible indicate existence of geoLayer
            var exist = false;
			getTime();
			createMap();
			$("#clock").click(function(){
				realTime = true;
				getTime();		
				createMap();
				if ($("#control").val() === 'Stop'){
					$("#control").attr("value",'Autoplay');
					console.log('cleaning setInterval...');
					clearInterval(int1);
				}
			});
			$("#control").click(function(){
				var value = $('#control').val();
				console.log(value);
				if (value === "Autoplay"){
					value = "Stop";
				}else{
					value = "Autoplay";
				}
				$("#control").attr("value",value);
				// update visualization on the basis of control
				if (value === "Stop"){
					realTime = false;
					time_id = 0;		
					int1 = setInterval(createMap, 1000);
				}else{
					console.log('cleaning setInterval...'); 
					clearInterval(int1);
				}
				
				});

		</script>
	</body>
</html>
